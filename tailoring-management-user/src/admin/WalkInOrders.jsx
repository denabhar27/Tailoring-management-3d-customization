import React, { useState, useEffect } from 'react';
import '../adminStyle/dryclean.css';
import AdminHeader from './AdminHeader';
import Sidebar from './Sidebar';
import { createWalkInDryCleaningOrder, createWalkInRepairOrder, createWalkInCustomizationOrder, createWalkInRentalOrder, searchWalkInCustomers } from '../api/WalkInOrderApi';
import { getAllDCGarmentTypesAdmin } from '../api/DryCleaningGarmentTypeApi';
import { getAllRepairGarmentTypesAdmin } from '../api/RepairGarmentTypeApi';
import { getAllGarmentTypesAdmin } from '../api/GarmentTypeApi';
import { getAllFabricTypesAdmin } from '../api/FabricTypeApi';
import { getAllRentals, getAvailableRentals, getRentalImageUrl } from '../api/RentalApi';
import { getAllPatterns } from '../api/PatternApi';
import { useAlert } from '../context/AlertContext';

const WalkInOrders = () => {
  const { alert } = useAlert();
  const [serviceType, setServiceType] = useState('dry_cleaning');
  const [loading, setLoading] = useState(false);
  const [submitting, setSubmitting] = useState(false);

  const [customerName, setCustomerName] = useState('');
  const [customerEmail, setCustomerEmail] = useState('');
  const [customerPhone, setCustomerPhone] = useState('');
  const [customerSearchResults, setCustomerSearchResults] = useState([]);
  const [showCustomerSearch, setShowCustomerSearch] = useState(false);

  const [garmentType, setGarmentType] = useState('');
  const [quantity, setQuantity] = useState(1);
  const [specialInstructions, setSpecialInstructions] = useState('');
  const [preferredPickupDate, setPreferredPickupDate] = useState('');
  const [preferredPickupTime, setPreferredPickupTime] = useState('');
  const [garmentTypes, setGarmentTypes] = useState([]);

  const [repairGarmentType, setRepairGarmentType] = useState('');
  const [damageLevel, setDamageLevel] = useState('');
  const [repairDescription, setRepairDescription] = useState('');
  const [repairPreferredDate, setRepairPreferredDate] = useState('');
  const [repairPreferredTime, setRepairPreferredTime] = useState('');
  const [estimatedRepairPrice, setEstimatedRepairPrice] = useState('');
  const [repairGarmentTypes, setRepairGarmentTypes] = useState([]);

  const [customGarmentType, setCustomGarmentType] = useState('');
  const [fabricType, setFabricType] = useState('');
  const [patternType, setPatternType] = useState('');
  const [customPreferredDate, setCustomPreferredDate] = useState('');
  const [customPreferredTime, setCustomPreferredTime] = useState('');
  const [estimatedCustomPrice, setEstimatedCustomPrice] = useState('');
  const [customGarmentTypes, setCustomGarmentTypes] = useState([]);
  const [fabricTypes, setFabricTypes] = useState([]);
  const [patterns, setPatterns] = useState([]);

  const [topMeasurements, setTopMeasurements] = useState({
    chest: '',
    shoulders: '',
    sleeve_length: '',
    neck: '',
    waist: '',
    length: ''
  });
  const [bottomMeasurements, setBottomMeasurements] = useState({
    waist: '',
    hips: '',
    inseam: '',
    length: '',
    thigh: '',
    outseam: ''
  });
  const [measurementNotes, setMeasurementNotes] = useState('');

  const [referenceImage, setReferenceImage] = useState(null);
  const [referenceImagePreview, setReferenceImagePreview] = useState(null);

  const [selectedRentalItems, setSelectedRentalItems] = useState([]); 
  const [rentalDuration, setRentalDuration] = useState(3);
  const [eventDate, setEventDate] = useState('');
  const [damageDeposit, setDamageDeposit] = useState('');
  const [availableRentals, setAvailableRentals] = useState([]);

  const [notes, setNotes] = useState('');

  useEffect(() => {
    loadGarmentTypes();
    loadRepairGarmentTypes();
    loadCustomGarmentTypes();
    loadFabricTypes();
    loadAvailableRentals();
    loadPatterns();
  }, []);

  const loadGarmentTypes = async () => {
    try {
      const result = await getAllDCGarmentTypesAdmin();
      if (result.success) {
        
        const types = result.data || result.types || result.garments || [];
        setGarmentTypes(types);
      }
    } catch (error) {
      console.error('Error loading garment types:', error);
    }
  };

  const loadRepairGarmentTypes = async () => {
    try {
      const result = await getAllRepairGarmentTypesAdmin();
      if (result.success) {
        const types = result.garments || result.data || [];
        setRepairGarmentTypes(types);
      }
    } catch (error) {
      console.error('Error loading repair garment types:', error);
    }
  };

  const loadCustomGarmentTypes = async () => {
    try {
      const result = await getAllGarmentTypesAdmin();
      if (result.success) {
        const types = result.garments || result.data || [];
        setCustomGarmentTypes(types);
      }
    } catch (error) {
      console.error('Error loading customization garment types:', error);
    }
  };

  const loadFabricTypes = async () => {
    try {
      const result = await getAllFabricTypesAdmin();
      if (result.success) {
        const types = result.fabrics || result.data || [];
        setFabricTypes(types);
      }
    } catch (error) {
      console.error('Error loading fabric types:', error);
    }
  };

  const loadPatterns = async () => {
    try {
      const result = await getAllPatterns();
      if (result.success) {
        
        const activePatterns = (result.patterns || []).filter(p => p.is_active !== 0);
        setPatterns(activePatterns);
      }
    } catch (error) {
      console.error('Error loading patterns:', error);
    }
  };

  const loadAvailableRentals = async () => {
    try {
      
      const result = await getAllRentals();
      console.log('All rentals result:', result); 
      
      let items = [];
      if (result.items && Array.isArray(result.items)) {
        
        items = result.items.filter(item => 
          item.status === 'available' && 
          (item.total_available === null || item.total_available === undefined || item.total_available > 0)
        );
      } else if (Array.isArray(result)) {
        
        items = result.filter(item => 
          item.status === 'available' && 
          (item.total_available === null || item.total_available === undefined || item.total_available > 0)
        );
      }
      
      console.log('Loaded available rental items:', items.length);
      setAvailableRentals(items);
    } catch (error) {
      console.error('Error loading available rentals:', error);
      setAvailableRentals([]);
    }
  };

  const handlePhoneChange = async (phone) => {
    setCustomerPhone(phone);
    if (phone.length >= 3) {
      try {
        const result = await searchWalkInCustomers(phone);
        if (result.success && result.customers) {
          setCustomerSearchResults(result.customers);
          setShowCustomerSearch(result.customers.length > 0);
        }
      } catch (error) {
        console.error('Error searching customers:', error);
      }
    } else {
      setShowCustomerSearch(false);
    }
  };

  const selectCustomer = (customer) => {
    setCustomerName(customer.name);
    setCustomerEmail(customer.email || '');
    setCustomerPhone(customer.phone);
    setShowCustomerSearch(false);
    setCustomerSearchResults([]);
  };

  const calculateDryCleaningPrice = () => {
    if (!garmentType || !quantity) return 0;
    const selectedGarment = garmentTypes.find(gt => gt.garment_name === garmentType);
    const pricePerItem = selectedGarment ? parseFloat(selectedGarment.garment_price || 200) : 200;
    return pricePerItem * parseInt(quantity);
  };

  const calculateRentalPrice = () => {
    if (selectedRentalItems.length === 0 || !rentalDuration) return 0;
    return selectedRentalItems.reduce((total, item) => {
      const basePrice = parseFloat(item.price || 0);
      return total + (basePrice * parseInt(rentalDuration));
    }, 0);
  };

  const formatMeasurements = (item) => {
    if (!item || !item.size) return null;
    
    try {
      let measurements;
      if (typeof item.size === 'string') {
        try {
          measurements = JSON.parse(item.size);
        } catch (e) {
          return null; 
        }
      } else {
        measurements = item.size;
      }
      
      if (!measurements || typeof measurements !== 'object' || Array.isArray(measurements)) {
        return null;
      }

      const measurementRows = Object.entries(measurements)
        .filter(([key, value]) => {
          if (typeof value === 'object' && value !== null) {
            return (value.inch && value.inch !== '' && value.inch !== '0') || 
                   (value.cm && value.cm !== '' && value.cm !== '0');
          }
          return value && value !== '' && value !== '0';
        })
        .map(([key, value]) => {
          
          let label = key.replace(/([A-Z])/g, ' $1');
          label = label.charAt(0).toUpperCase() + label.slice(1).toLowerCase();

          let displayValue = '';
          if (typeof value === 'object' && value !== null && value.inch !== undefined) {
            displayValue = `${value.inch}" (${value.cm} cm)`;
          } else if (value) {
            const inchValue = String(value);
            const cmValue = (parseFloat(inchValue) * 2.54).toFixed(2);
            displayValue = `${inchValue}" (${cmValue} cm)`;
          }
          
          return displayValue ? { label, value: displayValue } : null;
        })
        .filter(row => row !== null && row.value);
      
      return measurementRows.length > 0 ? measurementRows : null;
    } catch (e) {
      console.error('Error formatting measurements:', e);
      return null;
    }
  };

  const toggleRentalItemSelection = (item) => {
    setSelectedRentalItems(prev => {
      const isSelected = prev.some(i => i.item_id === item.item_id);
      if (isSelected) {
        return prev.filter(i => i.item_id !== item.item_id);
      } else {
        return [...prev, item];
      }
    });
  };

  const isRentalItemSelected = (item) => {
    return selectedRentalItems.some(i => i.item_id === item.item_id);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    if (!customerName || !customerPhone) {
      alert('Please enter customer name and phone number');
      return;
    }

    if (serviceType === 'dry_cleaning') {
      if (!garmentType || !quantity) {
        alert('Please select garment type and quantity');
        return;
      }
    } else if (serviceType === 'repair') {
      if (!repairGarmentType || !damageLevel || !repairDescription) {
        alert('Please fill in all required repair fields');
        return;
      }
    } else if (serviceType === 'customization') {
      if (!customGarmentType) {
        alert('Please select garment type');
        return;
      }
    } else if (serviceType === 'rental') {
      if (selectedRentalItems.length === 0 || !rentalDuration) {
        alert('Please select at least one rental item and duration');
        return;
      }
    }

    setSubmitting(true);

    try {
      let result;
      
      if (serviceType === 'dry_cleaning') {
        const pricePerItem = garmentTypes.find(gt => gt.garment_name === garmentType)?.garment_price || 200;
        result = await createWalkInDryCleaningOrder({
          customerName,
          customerEmail,
          customerPhone,
          garmentType,
          quantity: parseInt(quantity),
          specialInstructions,
          preferredPickupDate,
          preferredPickupTime,
          pricingFactors: {
            pricePerItem: pricePerItem.toString(),
            quantity: quantity.toString()
          },
          notes
        });
      } else if (serviceType === 'repair') {
        result = await createWalkInRepairOrder({
          customerName,
          customerEmail,
          customerPhone,
          garmentType: repairGarmentType,
          damageLevel,
          description: repairDescription,
          preferredDate: repairPreferredDate,
          preferredTime: repairPreferredTime,
          estimatedPrice: estimatedRepairPrice || '0',
          notes
        });
      } else if (serviceType === 'customization') {
        
        const structuredMeasurements = {
          top: topMeasurements,
          bottom: bottomMeasurements,
          notes: measurementNotes
        };
        
        result = await createWalkInCustomizationOrder({
          customerName,
          customerEmail,
          customerPhone,
          garmentType: customGarmentType,
          fabricType,
          patternType,
          measurements: structuredMeasurements,
          preferredDate: customPreferredDate,
          preferredTime: customPreferredTime,
          estimatedPrice: estimatedCustomPrice || '0',
          notes,
          referenceImage: referenceImage
        });
      } else if (serviceType === 'rental') {
        
        const totalDownpayment = selectedRentalItems.reduce((sum, item) => {
          return sum + parseFloat(item.downpayment || '0');
        }, 0);
        
        result = await createWalkInRentalOrder({
          customerName,
          customerEmail,
          customerPhone,
          rentalItemIds: selectedRentalItems.map(item => item.item_id), 
          rentalDuration: parseInt(rentalDuration),
          eventDate,
          damageDeposit: damageDeposit || totalDownpayment.toString(),
          isBundle: selectedRentalItems.length > 1,
          notes
        });
      }

      if (result.success) {
        alert('Walk-in order created successfully!', 'success');
        
        setCustomerName('');
        setCustomerEmail('');
        setCustomerPhone('');
        setGarmentType('');
        setQuantity(1);
        setSpecialInstructions('');
        setPreferredPickupDate('');
        setPreferredPickupTime('');
        setSelectedRentalItems([]);
        setRentalDuration(3);
        setEventDate('');
        setDamageDeposit('');
        setNotes('');
        
        setCustomGarmentType('');
        setFabricType('');
        setPatternType('');
        setTopMeasurements({ chest: '', shoulders: '', sleeve_length: '', neck: '', waist: '', length: '' });
        setBottomMeasurements({ waist: '', hips: '', inseam: '', length: '', thigh: '', outseam: '' });
        setMeasurementNotes('');
        setCustomPreferredDate('');
        setCustomPreferredTime('');
        setEstimatedCustomPrice('');
        setReferenceImage(null);
        setReferenceImagePreview(null);
        
        if (serviceType === 'rental') {
          loadAvailableRentals();
        }
      } else {
        alert(result.message || 'Failed to create walk-in order', 'error');
      }
    } catch (error) {
      console.error('Error creating walk-in order:', error);
      alert('An error occurred while creating the order', 'error');
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <div className="admin-page">
      <Sidebar />
      <AdminHeader />
      
      <div className="content">
        <div className="dashboard-title">
          <h2>New Walk-In Order</h2>
        </div>

        <div className="form-container" style={{ maxWidth: '800px', margin: '0 auto' }}>
          <div className="form-group">
            <label>Service Type *</label>
            <select 
              value={serviceType} 
              onChange={(e) => setServiceType(e.target.value)}
              className="form-control"
            >
              <option value="dry_cleaning">Dry Cleaning</option>
              <option value="repair">Repair</option>
              <option value="customization">Customization</option>
              <option value="rental">Rental</option>
            </select>
          </div>
          <div className="form-section">
            <h3>Customer Information</h3>
            
            <div className="form-group">
              <label>Phone Number *</label>
              <input
                type="tel"
                value={customerPhone}
                onChange={(e) => handlePhoneChange(e.target.value)}
                className="form-control"
                placeholder="Enter phone number"
                required
              />
              {showCustomerSearch && customerSearchResults.length > 0 && (
                <div className="customer-search-results">
                  {customerSearchResults.map(customer => (
                    <div 
                      key={customer.id} 
                      className="customer-search-item"
                      onClick={() => selectCustomer(customer)}
                    >
                      <strong>{customer.name}</strong> - {customer.phone}
                      {customer.email && <span> ({customer.email})</span>}
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="form-group">
              <label>Full Name *</label>
              <input
                type="text"
                value={customerName}
                onChange={(e) => setCustomerName(e.target.value)}
                className="form-control"
                placeholder="Enter customer name"
                required
              />
            </div>

            <div className="form-group">
              <label>Email</label>
              <input
                type="email"
                value={customerEmail}
                onChange={(e) => setCustomerEmail(e.target.value)}
                className="form-control"
                placeholder="Enter email (optional)"
              />
            </div>
          </div>
          {serviceType === 'dry_cleaning' && (
            <div className="form-section">
              <h3>Dry Cleaning Details</h3>
              
              <div className="form-group">
                <label>Garment Type *</label>
                <select
                  value={garmentType}
                  onChange={(e) => setGarmentType(e.target.value)}
                  className="form-control"
                  required
                >
                  <option value="">Select garment type</option>
                  {garmentTypes.map(gt => (
                    <option key={gt.garment_type_id} value={gt.garment_name}>
                      {gt.garment_name} - â‚±{gt.garment_price}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label>Quantity *</label>
                <input
                  type="number"
                  value={quantity}
                  onChange={(e) => setQuantity(e.target.value)}
                  className="form-control"
                  min="1"
                  required
                />
              </div>

              <div className="form-group">
                <label>Special Instructions</label>
                <textarea
                  value={specialInstructions}
                  onChange={(e) => setSpecialInstructions(e.target.value)}
                  className="form-control"
                  rows="3"
                  placeholder="Any special instructions..."
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Preferred Pickup Date</label>
                  <input
                    type="date"
                    value={preferredPickupDate}
                    onChange={(e) => setPreferredPickupDate(e.target.value)}
                    className="form-control"
                    min={new Date().toISOString().split('T')[0]}
                  />
                </div>

                <div className="form-group">
                  <label>Preferred Pickup Time</label>
                  <input
                    type="time"
                    value={preferredPickupTime}
                    onChange={(e) => setPreferredPickupTime(e.target.value)}
                    className="form-control"
                  />
                </div>
              </div>

              <div className="price-display">
                <strong>Total Price: â‚±{calculateDryCleaningPrice().toFixed(2)}</strong>
              </div>
            </div>
          )}

          {serviceType === 'repair' && (
            <div className="form-section">
              <h3>Repair Details</h3>
              
              <div className="form-group">
                <label>Garment Type *</label>
                <select
                  value={repairGarmentType}
                  onChange={(e) => setRepairGarmentType(e.target.value)}
                  className="form-control"
                  required
                >
                  <option value="">Select garment type</option>
                  {repairGarmentTypes.map(gt => (
                    <option key={gt.garment_type_id} value={gt.garment_name}>
                      {gt.garment_name}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label>Damage Level *</label>
                <select
                  value={damageLevel}
                  onChange={(e) => setDamageLevel(e.target.value)}
                  className="form-control"
                  required
                >
                  <option value="">Select damage level</option>
                  <option key="minor" value="minor">Minor</option>
                  <option key="moderate" value="moderate">Moderate</option>
                  <option key="severe" value="severe">Severe</option>
                </select>
              </div>

              <div className="form-group">
                <label>Description *</label>
                <textarea
                  value={repairDescription}
                  onChange={(e) => setRepairDescription(e.target.value)}
                  className="form-control"
                  rows="4"
                  placeholder="Describe the damage and repair needed..."
                  required
                />
              </div>

              <div className="form-row">
                <div className="form-group">
                  <label>Preferred Date</label>
                  <input
                    type="date"
                    value={repairPreferredDate}
                    onChange={(e) => setRepairPreferredDate(e.target.value)}
                    className="form-control"
                    min={new Date().toISOString().split('T')[0]}
                  />
                </div>

                <div className="form-group">
                  <label>Preferred Time</label>
                  <input
                    type="time"
                    value={repairPreferredTime}
                    onChange={(e) => setRepairPreferredTime(e.target.value)}
                    className="form-control"
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Final Price</label>
                <input
                  type="number"
                  value={estimatedRepairPrice}
                  onChange={(e) => setEstimatedRepairPrice(e.target.value)}
                  className="form-control"
                  min="0"
                  step="0.01"
                  placeholder="Enter final price (optional)"
                />
              </div>
            </div>
          )}

          {serviceType === 'customization' && (
            <div className="form-section">
              <h3>Customization Details</h3>
              
              <div className="form-group">
                <label>Garment Type *</label>
                <select
                  value={customGarmentType}
                  onChange={(e) => setCustomGarmentType(e.target.value)}
                  className="form-control"
                  required
                >
                  <option value="">Select garment type</option>
                  {customGarmentTypes.map(gt => (
                    <option key={gt.garment_type_id} value={gt.garment_name}>
                      {gt.garment_name}
                    </option>
                  ))}
                  <option value="Uniform">ðŸ‘” Uniform (Price varies)</option>
                </select>
              </div>
              {customGarmentType === 'Uniform' && (
                <div style={{ 
                  backgroundColor: '#fff3e0', 
                  padding: '12px 15px', 
                  borderRadius: '8px', 
                  marginBottom: '15px',
                  border: '1px solid #ffb74d',
                  display: 'flex',
                  alignItems: 'flex-start',
                  gap: '10px'
                }}>
                  <span style={{ fontSize: '24px' }}>ðŸ‘”</span>
                  <div>
                    <strong style={{ color: '#e65100' }}>Uniform Order</strong>
                    <p style={{ margin: '5px 0 0 0', fontSize: '13px', color: '#666' }}>
                      Price varies by uniform type and complexity. Please collect a reference image from the customer and note any specific requirements.
                    </p>
                  </div>
                </div>
              )}

              <div className="form-group">
                <label>Fabric Type</label>
                <select
                  value={fabricType}
                  onChange={(e) => setFabricType(e.target.value)}
                  className="form-control"
                  disabled={customGarmentType === 'Uniform'}
                >
                  <option value="">{customGarmentType === 'Uniform' ? 'N/A for Uniform' : 'Select fabric type (optional)'}</option>
                  {fabricTypes.map(ft => (
                    <option key={ft.fabric_type_id} value={ft.fabric_name}>
                      {ft.fabric_name}
                    </option>
                  ))}
                </select>
              </div>

              <div className="form-group">
                <label>Pattern</label>
                <select
                  value={patternType}
                  onChange={(e) => setPatternType(e.target.value)}
                  className="form-control"
                >
                  <option value="">None (optional)</option>
                  {patterns.map(pt => (
                    <option key={pt.pattern_id} value={pt.pattern_name}>
                      {pt.pattern_name}
                    </option>
                  ))}
                </select>
              </div>
              <div className="form-group" style={{ marginTop: '15px' }}>
                <label>Reference Image (Optional)</label>
                <p style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>
                  Upload a reference image from the customer to help with the customization.
                </p>
                <input
                  type="file"
                  accept="image/*"
                  onChange={(e) => {
                    const file = e.target.files[0];
                    if (file) {
                      setReferenceImage(file);
                      const reader = new FileReader();
                      reader.onloadend = () => {
                        setReferenceImagePreview(reader.result);
                      };
                      reader.readAsDataURL(file);
                    }
                  }}
                  className="form-control"
                  style={{ padding: '8px' }}
                />
                {referenceImagePreview && (
                  <div style={{ marginTop: '10px', position: 'relative', display: 'inline-block' }}>
                    <img 
                      src={referenceImagePreview} 
                      alt="Reference preview" 
                      style={{ 
                        maxWidth: '200px', 
                        maxHeight: '200px', 
                        borderRadius: '8px',
                        border: '2px solid #8b4513'
                      }} 
                    />
                    <button
                      type="button"
                      onClick={() => {
                        setReferenceImage(null);
                        setReferenceImagePreview(null);
                      }}
                      style={{
                        position: 'absolute',
                        top: '-8px',
                        right: '-8px',
                        background: '#dc3545',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '50%',
                        width: '24px',
                        height: '24px',
                        cursor: 'pointer',
                        fontSize: '14px',
                        fontWeight: 'bold'
                      }}
                    >
                      Ã—
                    </button>
                  </div>
                )}
              </div>
              <div className="measurements-section" style={{ marginTop: '20px', padding: '15px', backgroundColor: '#f9f9f9', borderRadius: '8px' }}>
                <h4 style={{ marginBottom: '15px', color: '#5D4037' }}>Customer Measurements</h4>
                
                <div style={{ display: 'flex', gap: '20px' }}>
                  <div style={{ flex: 1, padding: '15px', backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #eee' }}>
                    <p style={{ fontWeight: '600', marginBottom: '15px', color: '#333', textAlign: 'center' }}>Top Measurements</p>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px 10px' }}>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Chest (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.chest}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, chest: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 40"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Shoulders (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.shoulders}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, shoulders: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 18"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Sleeve Length (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.sleeve_length}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, sleeve_length: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 25"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Neck (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.neck}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, neck: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 16"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Waist (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.waist}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, waist: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 34"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Length (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={topMeasurements.length}
                          onChange={(e) => setTopMeasurements({ ...topMeasurements, length: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 28"
                        />
                      </div>
                    </div>
                  </div>
                  <div style={{ flex: 1, padding: '15px', backgroundColor: '#fff', borderRadius: '8px', border: '1px solid #eee' }}>
                    <p style={{ fontWeight: '600', marginBottom: '15px', color: '#333', textAlign: 'center' }}>Bottom Measurements</p>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px 10px' }}>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Waist (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.waist}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, waist: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 32"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Hips (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.hips}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, hips: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 40"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Inseam (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.inseam}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, inseam: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 30"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Length (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.length}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, length: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 42"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Thigh (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.thigh}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, thigh: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 24"
                        />
                      </div>
                      <div className="form-group" style={{ marginBottom: '0' }}>
                        <label style={{ fontSize: '13px', display: 'block', minHeight: '36px', marginBottom: '5px' }}>Outseam (inches)</label>
                        <input
                          type="number"
                          step="0.1"
                          value={bottomMeasurements.outseam}
                          onChange={(e) => setBottomMeasurements({ ...bottomMeasurements, outseam: e.target.value })}
                          className="form-control"
                          placeholder="e.g. 44"
                        />
                      </div>
                    </div>
                  </div>
                </div>
                <div style={{ marginTop: '15px' }}>
                  <label style={{ fontSize: '13px', fontWeight: '500' }}>Measurement Notes</label>
                  <textarea
                    value={measurementNotes}
                    onChange={(e) => setMeasurementNotes(e.target.value)}
                    className="form-control"
                    rows="2"
                    placeholder="Any additional notes about measurements..."
                  />
                </div>
              </div>

              <div className="form-row" style={{ marginTop: '20px' }}>
                <div className="form-group">
                  <label>Preferred Date</label>
                  <input
                    type="date"
                    value={customPreferredDate}
                    onChange={(e) => setCustomPreferredDate(e.target.value)}
                    className="form-control"
                    min={new Date().toISOString().split('T')[0]}
                  />
                </div>

                <div className="form-group">
                  <label>Preferred Time</label>
                  <input
                    type="time"
                    value={customPreferredTime}
                    onChange={(e) => setCustomPreferredTime(e.target.value)}
                    className="form-control"
                  />
                </div>
              </div>

              <div className="form-group">
                <label>Final Price</label>
                <input
                  type="number"
                  value={estimatedCustomPrice}
                  onChange={(e) => setEstimatedCustomPrice(e.target.value)}
                  className="form-control"
                  min="0"
                  step="0.01"
                  placeholder="Enter final price (optional)"
                />
              </div>
            </div>
          )}

          {serviceType === 'rental' && (
            <div className="form-section">
              <h3>Rental Details</h3>
              
              <div className="form-group">
                <label>Select Rental Item *</label>
                {availableRentals.length === 0 ? (
                  <div style={{ 
                    padding: '40px', 
                    textAlign: 'center', 
                    color: '#888',
                    backgroundColor: '#f9f9f9',
                    borderRadius: '8px'
                  }}>
                    No available rental items found. Please add items in Post Rent first.
                  </div>
                ) : (
                  <div className="rental-items-grid">
                    {availableRentals.map(item => {
                      const isSelected = isRentalItemSelected(item);
                      const imageUrl = item.front_image 
                        ? getRentalImageUrl(item.front_image) 
                        : (item.image_url ? getRentalImageUrl(item.image_url) : null);
                      const measurements = formatMeasurements(item);
                      
                      return (
                        <div
                          key={item.item_id}
                          className={`rental-item-card ${isSelected ? 'selected' : ''}`}
                          onClick={() => toggleRentalItemSelection(item)}
                        >
                          <div className="rental-item-image-container">
                            {imageUrl ? (
                              <img 
                                src={imageUrl} 
                                alt={item.item_name}
                                className="rental-item-image"
                              />
                            ) : (
                              <div className="rental-item-placeholder">
                                No Image
                              </div>
                            )}
                            {isSelected && (
                              <div className="rental-item-selected-badge">
                                âœ“ Selected
                              </div>
                            )}
                          </div>
                          <div className="rental-item-card-info">
                            <h4 className="rental-item-name">{item.item_name}</h4>
                            {item.brand && (
                              <p className="rental-item-brand">{item.brand}</p>
                            )}
                            {measurements && measurements.length > 0 && (
                              <div className="rental-item-measurements">
                                {measurements.slice(0, 3).map((m, idx) => (
                                  <span key={idx} className="measurement-tag">
                                    {m.label}: {m.value}
                                  </span>
                                ))}
                                {measurements.length > 3 && (
                                  <span className="measurement-tag">
                                    +{measurements.length - 3} more
                                  </span>
                                )}
                              </div>
                            )}
                            <p className="rental-item-price">
                              â‚±{parseFloat(item.price || 0).toLocaleString('en-PH', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                              })} per 3 days
                            </p>
                            {item.category && (
                              <span className="rental-item-category">{item.category}</span>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>

              {selectedRentalItems.length > 0 && (
                <div className="selected-rental-details">
                  <h4>Selected Items ({selectedRentalItems.length}):</h4>
                  <div className="selected-items-list">
                    {selectedRentalItems.map((item, idx) => {
                      const measurements = formatMeasurements(item);
                      return (
                        <div key={item.item_id} className="selected-item-detail">
                          <div className="selected-item-header">
                            <strong>{item.item_name}</strong>
                            <button
                              type="button"
                              className="remove-item-btn"
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleRentalItemSelection(item);
                              }}
                            >
                              Ã— Remove
                            </button>
                          </div>
                          {item.brand && <p><strong>Brand:</strong> {item.brand}</p>}
                          {item.category && <p><strong>Category:</strong> {item.category}</p>}
                          {measurements && measurements.length > 0 && (
                            <div className="measurements-display">
                              <strong>Measurements:</strong>
                              <div className="measurements-grid">
                                {measurements.map((m, mIdx) => (
                                  <div key={mIdx} className="measurement-item">
                                    <span className="measurement-label">{m.label}:</span>
                                    <span className="measurement-value">{m.value}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          {item.description && (
                            <p><strong>Description:</strong> {item.description}</p>
                          )}
                          {item.material && (
                            <p><strong>Material:</strong> {item.material}</p>
                          )}
                          <p><strong>Price:</strong> â‚±{parseFloat(item.price || 0).toLocaleString('en-PH', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                          })} per 3 days</p>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}

              <div className="form-group">
                <label>Rental Duration (days) *</label>
                <input
                  type="number"
                  value={rentalDuration}
                  onChange={(e) => setRentalDuration(e.target.value)}
                  className="form-control"
                  min="3"
                  step="3"
                  required
                />
                <small>Must be a multiple of 3 days</small>
              </div>

              <div className="form-group">
                <label>Event Date</label>
                <input
                  type="date"
                  value={eventDate}
                  onChange={(e) => setEventDate(e.target.value)}
                  className="form-control"
                  min={new Date().toISOString().split('T')[0]}
                />
              </div>

              <div className="price-display">
                <strong>Total Price: â‚±{calculateRentalPrice().toFixed(2)}</strong>
              </div>
            </div>
          )}
          <div className="form-group">
            <label>Order Notes</label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              className="form-control"
              rows="3"
              placeholder="Any additional notes..."
            />
          </div>
          <div className="form-actions">
            <button
              type="submit"
              onClick={handleSubmit}
              disabled={submitting}
              className="btn btn-primary"
            >
              {submitting ? 'Creating Order...' : 'Create Walk-In Order'}
            </button>
          </div>
        </div>
      </div>

      <style>{`
        .form-container {
          background: white;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-section {
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 1px solid #eee;
        }
        .form-section h3 {
          margin-bottom: 20px;
          color: #5D4037;
        }
        .form-group {
          margin-bottom: 20px;
        }
        .form-group label {
          display: block;
          margin-bottom: 5px;
          font-weight: 500;
        }
        .form-control {
          width: 100%;
          padding: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 14px;
        }
        .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
        }
        .customer-search-results {
          margin-top: 5px;
          border: 1px solid #ddd;
          border-radius: 4px;
          max-height: 200px;
          overflow-y: auto;
        }
        .customer-search-item {
          padding: 10px;
          cursor: pointer;
          border-bottom: 1px solid #eee;
        }
        .customer-search-item:hover {
          background: #f5f5f5;
        }
        .price-display {
          padding: 15px;
          background: #f9f9f9;
          border-radius: 4px;
          margin-top: 15px;
          font-size: 18px;
        }
        .rental-item-preview {
          padding: 15px;
          background: #f9f9f9;
          border-radius: 4px;
          margin-bottom: 15px;
        }
        .form-actions {
          margin-top: 30px;
          text-align: right;
        }
        .btn {
          padding: 12px 30px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          font-size: 16px;
        }
        .btn-primary {
          background: #5D4037;
          color: white;
        }
        .btn-primary:hover:not(:disabled) {
          background: #4a3329;
        }
        .btn-primary:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
        .rental-items-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 20px;
          margin-top: 15px;
        }
        .rental-item-card {
          background-color: white;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          transition: all 0.3s ease;
          cursor: pointer;
          border: 2px solid transparent;
        }
        .rental-item-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          border-color: #8B4513;
        }
        .rental-item-card.selected {
          border-color: #8B4513;
          box-shadow: 0 4px 16px rgba(139, 69, 19, 0.3);
        }
        .rental-item-image-container {
          position: relative;
          width: 100%;
          height: 180px;
          background-color: #f8f9fa;
          overflow: hidden;
        }
        .rental-item-image {
          width: 100%;
          height: 100%;
          object-fit: contain;
          background-color: #f8f9fa;
        }
        .rental-item-placeholder {
          width: 100%;
          height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: #999;
          font-size: 14px;
          background-color: #f5f5f5;
        }
        .rental-item-selected-badge {
          position: absolute;
          top: 8px;
          right: 8px;
          background-color: #8B4513;
          color: white;
          padding: 4px 10px;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 600;
        }
        .rental-item-card-info {
          padding: 12px;
        }
        .rental-item-name {
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 8px 0;
          color: #2D3436;
        }
        .rental-item-brand {
          font-size: 13px;
          color: #636E72;
          margin: 4px 0;
        }
        .rental-item-size {
          font-size: 12px;
          color: #636E72;
          margin: 4px 0;
        }
        .rental-item-price {
          font-size: 14px;
          font-weight: 600;
          color: #8B4513;
          margin: 8px 0 4px 0;
        }
        .rental-item-category {
          display: inline-block;
          font-size: 11px;
          padding: 2px 8px;
          background-color: #f0f0f0;
          border-radius: 4px;
          color: #636E72;
          margin-top: 4px;
        }
        .selected-rental-details {
          margin-top: 20px;
          padding: 15px;
          background-color: #f9f9f9;
          border-radius: 8px;
          border-left: 4px solid #8B4513;
        }
        .selected-rental-details h4 {
          margin: 0 0 10px 0;
          color: #8B4513;
        }
        .selected-rental-details p {
          margin: 5px 0;
          color: #555;
        }
        .selected-items-list {
          margin-top: 15px;
        }
        .selected-item-detail {
          background-color: white;
          border: 1px solid #ddd;
          border-radius: 6px;
          padding: 15px;
          margin-bottom: 15px;
        }
        .selected-item-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
          padding-bottom: 10px;
          border-bottom: 1px solid #eee;
        }
        .remove-item-btn {
          background-color: #dc3545;
          color: white;
          border: none;
          padding: 4px 10px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 12px;
        }
        .remove-item-btn:hover {
          background-color: #c82333;
        }
        .measurements-display {
          margin-top: 10px;
        }
        .measurements-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
          gap: 8px;
          margin-top: 8px;
          padding: 10px;
          background-color: #f9f9f9;
          border-radius: 4px;
        }
        .measurement-item {
          display: flex;
          flex-direction: column;
        }
        .measurement-label {
          font-size: 11px;
          color: #666;
          font-weight: 500;
        }
        .measurement-value {
          font-size: 13px;
          color: #333;
          font-weight: 600;
        }
        .rental-item-measurements {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;
          margin: 8px 0;
        }
        .measurement-tag {
          font-size: 10px;
          padding: 2px 6px;
          background-color: #e9ecef;
          border-radius: 3px;
          color: #495057;
        }
      `}</style>
    </div>
  );
};

export default WalkInOrders;

